<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÂçÅÂÖ≠ÂÜõÂõ¢ÊàòÊä•</title>
    <script src="./lib/tailwindcss.js"></script>
    <script src="./lib/vue.global.js"></script>
    <script src="./lib/echarts.min.js"></script>
    <script src="./lib/axios.min.js"></script>
    <style>
        body {
            background-color: #0f172a; /* Dark Slate 900 */
            color: #e2e8f0; /* Slate 200 */
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden;
            transition: background-color 0.5s;
        }
        
        /* Game Style Card */
        .game-card {
            background: rgba(30, 41, 59, 0.7); /* Slate 800 with opacity */
            backdrop-filter: blur(12px);
            border: 1px solid rgba(59, 130, 246, 0.3); /* Blue border */
            border-radius: 0.5rem;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.3), inset 0 0 20px rgba(59, 130, 246, 0.05);
            transition: all 0.3s ease;
            position: relative;
        }
        .game-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; width: 100%; height: 2px;
            background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.8), transparent);
            opacity: 0.5;
        }
        .game-card:hover {
            box-shadow: 0 0 25px rgba(59, 130, 246, 0.2), inset 0 0 30px rgba(59, 130, 246, 0.1);
            border-color: rgba(59, 130, 246, 0.6);
        }

        /* Neon Text */
        .neon-text {
            text-shadow: 0 0 10px rgba(56, 189, 248, 0.6);
        }
        .neon-green {
            text-shadow: 0 0 10px rgba(74, 222, 128, 0.6);
        }
        .neon-amber {
            text-shadow: 0 0 10px rgba(251, 191, 36, 0.6);
        }
        .neon-gold {
            text-shadow: 0 0 10px rgba(253, 224, 71, 0.6);
            color: #fde047;
        }
        .neon-cyan {
            text-shadow: 0 0 10px rgba(34, 211, 238, 0.6);
            color: #22d3ee;
        }
        .neon-purple {
            text-shadow: 0 0 10px rgba(192, 132, 252, 0.6);
            color: #c084fc;
        }

        /* Title Gradient */
        .gradient-title {
            background: linear-gradient(to right, #60a5fa, #a78bfa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 20px rgba(96, 165, 250, 0.4);
        }

        [v-cloak] { 
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        /* Feed Scroll */
        .feed-scroll-wrapper {
            position: relative;
            overflow: hidden;
            height: 100%;
        }
        .feed-scroll-content {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            padding: 1rem;
            transition: transform 0.5s ease-in-out;
        }

        /* Custom Scrollbar for Webkit */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b; 
        }
        ::-webkit-scrollbar-thumb {
            background: #475569; 
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b; 
        }

        /* Theme overrides */
        .theme-saas {
            background-color: #f8fafc;
            color: #334155;
        }
        .theme-saas .game-card {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border-radius: 0.5rem;
        }
        .theme-saas .game-card::before { display: none; }
        .theme-saas .neon-text { text-shadow: none; color: #2563eb; }
        .theme-saas .neon-green { text-shadow: none; color: #16a34a; }
        .theme-saas .neon-amber { text-shadow: none; color: #d97706; }
        .theme-saas .neon-purple { text-shadow: none; color: #9333ea; }
        .theme-saas header { background: #ffffff; }
        .theme-saas .gradient-title {
            background: none;
            -webkit-text-fill-color: #1e293b;
            text-shadow: none;
        }

        .theme-space {
            background-color: #000000;
            color: #cbd5e1;
        }
        .theme-space .game-card {
            background: #0a0a0a;
            border: 1px solid #333;
        }
        .theme-space .neon-text { text-shadow: none; font-weight: 400; letter-spacing: 2px; }

        @media (max-width: 1024px) {
            body { overflow: auto; }
            .h-screen { height: auto; min-height: 100vh; }
        }
    </style>
</head>
<body :class="currentThemeClass">
    <!-- Error Layer -->
    <div id="error-layer" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; color: #ef4444; padding: 20px; font-family: monospace;">
        <h2 style="font-size: 24px; margin-bottom: 20px; text-shadow: 0 0 10px red;">‚ö†Ô∏è SYSTEM CRITICAL ERROR</h2>
        <pre id="error-message"></pre>
    </div>

    <div id="app" v-cloak class="h-screen flex flex-col p-4 md:p-6 gap-4 md:gap-6 bg-slate-900" :class="currentThemeClass === 'theme-saas' ? 'bg-slate-50' : (currentThemeClass === 'theme-space' ? 'bg-black' : 'bg-slate-900')">
        <!-- Header -->
        <header class="flex justify-between items-center game-card p-4">
            <div class="flex items-center gap-6">
                <div class="w-1 h-12 bg-blue-500 shadow-[0_0_10px_#3b82f6]"></div>
                <div>
                    <h1 class="text-4xl font-black tracking-tighter gradient-title italic">ÂçÅÂÖ≠ÂÜõÂõ¢ÊàòÊä•</h1>
                    <div class="flex gap-6 mt-2 text-sm font-bold tracking-wide">
                        <!-- Dept Tags -->
                        <span 
                            v-for="(tag, index) in departmentTags" 
                            :key="tag.code"
                            class="cursor-pointer transition-all px-3 py-1 rounded border border-transparent hover:border-blue-500/50 hover:bg-blue-500/10"
                            :class="currentDeptIndex === index ? 'text-blue-400 border-blue-500 bg-blue-500/20 shadow-[0_0_10px_rgba(59,130,246,0.3)]' : 'text-slate-500'"
                            @click="lockDepartment(index)"
                        >
                            <span v-if="currentDeptIndex === index" class="mr-1 animate-pulse">‚óà</span>
                            {{ tag.name }}
                        </span>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <!-- Theme Switcher -->
                <select v-model="currentTheme" class="bg-transparent border border-slate-600 text-xs rounded p-1 outline-none mr-2">
                    <option value="cyberpunk">Classic Game</option>
                    <option value="saas">SaaS Light</option>
                    <option value="space">Deep Space</option>
                </select>

                <!-- Actions -->
                <a :href="adminUrl" target="_blank" 
                   class="px-4 py-2 bg-slate-800 hover:bg-slate-700 border border-slate-700 hover:border-blue-500 text-slate-300 hover:text-white rounded flex items-center gap-2 transition-all shadow-lg">
                    <span class="text-blue-500">‚öôÔ∏è</span>
                    <span>Á≥ªÁªüÁÆ°ÁêÜ</span>
                </a>
                <a href="user_guide.md" target="_blank"
                   class="px-4 py-2 bg-slate-800 hover:bg-slate-700 border border-slate-700 hover:border-green-500 text-slate-300 hover:text-white rounded flex items-center gap-2 transition-all shadow-lg">
                    <span class="text-green-500">üìò</span>
                    <span>ËØ¥Êòé‰π¶</span>
                </a>
                
                <div class="text-right border-l pl-6 border-slate-700 ml-2">
                    <div class="text-3xl font-mono font-bold text-blue-400 neon-text tracking-widest">{{ currentTime }}</div>
                    <div class="text-[10px] text-slate-500 flex items-center justify-end gap-2 uppercase tracking-widest mt-1">
                        SYSTEM ONLINE <span class="w-1.5 h-1.5 bg-green-500 rounded-full animate-ping"></span>
                    </div>
                </div>
            </div>
        </header>

        <!-- KPI Cards: Aligned with Financial Targets -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6 h-auto md:h-32">
            <!-- Card 1: Signed Amount -->
            <div class="game-card p-5 flex flex-col justify-between group overflow-hidden">
                <div class="absolute -right-4 -top-4 w-24 h-24 bg-green-500/10 rounded-full blur-xl group-hover:bg-green-500/20 transition-all"></div>
                <div>
                    <div class="text-slate-400 text-xs font-bold uppercase tracking-widest">Êñ∞Á≠æÂêàÂêåÈ¢ù (SIGNED)</div>
                    <div class="text-4xl font-black text-green-400 mt-1 font-mono neon-green">
                        <span class="text-2xl text-slate-500 align-top">¬•</span>
                        {{ formatWan(stats.financials?.actual_signed) }}
                        <span class="text-sm text-slate-500 font-medium">‰∏á</span>
                    </div>
                </div>
                <div class="flex justify-between items-end mt-2 border-t border-slate-700/50 pt-2">
                     <div class="text-[10px] text-slate-500 uppercase tracking-wider">Target</div>
                     <div class="text-xs font-bold text-slate-400">¬• {{ formatWan(stats.financials?.target_signed) }} ‰∏á</div>
                </div>
            </div>

            <!-- Card 2: Return Profit -->
            <div class="game-card p-5 flex flex-col justify-between group overflow-hidden">
                <div class="absolute -right-4 -top-4 w-24 h-24 bg-purple-500/10 rounded-full blur-xl group-hover:bg-purple-500/20 transition-all"></div>
                <div>
                    <div class="text-slate-400 text-xs font-bold uppercase tracking-widest">ÂõûÊ¨æÊØõÂà© (RETURN)</div>
                    <div class="text-4xl font-black text-purple-400 mt-1 font-mono neon-purple">
                        <span class="text-2xl text-slate-500 align-top">¬•</span>
                        {{ formatWan(stats.financials?.actual_return_profit) }}
                        <span class="text-sm text-slate-500 font-medium">‰∏á</span>
                    </div>
                </div>
                <div class="flex justify-between items-end mt-2 border-t border-slate-700/50 pt-2">
                     <div class="text-[10px] text-slate-500 uppercase tracking-wider">Target</div>
                     <div class="text-xs font-bold text-slate-400">¬• {{ formatWan(stats.financials?.target_return_profit) }} ‰∏á</div>
                </div>
            </div>

            <!-- Card 3: Revenue -->
            <div class="game-card p-5 flex flex-col justify-between group overflow-hidden">
                <div class="absolute -right-4 -top-4 w-24 h-24 bg-amber-500/10 rounded-full blur-xl group-hover:bg-amber-500/20 transition-all"></div>
                <div>
                    <div class="text-slate-400 text-xs font-bold uppercase tracking-widest">Á°ÆËÆ§Êî∂ÂÖ• (REVENUE)</div>
                    <div class="text-4xl font-black text-amber-400 mt-1 font-mono neon-amber">
                        <span class="text-2xl text-slate-500 align-top">¬•</span>
                        {{ formatWan(stats.financials?.actual_revenue) }}
                        <span class="text-sm text-slate-500 font-medium">‰∏á</span>
                    </div>
                </div>
                <div class="flex justify-between items-end mt-2 border-t border-slate-700/50 pt-2">
                     <div class="text-[10px] text-slate-500 uppercase tracking-wider">Target</div>
                     <div class="text-xs font-bold text-slate-400">¬• {{ formatWan(stats.financials?.target_revenue) }} ‰∏á</div>
                </div>
            </div>
        </div>

        <!-- Charts Area -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6 flex-1 min-h-0">
            <!-- Left: Gauge & Funnel -->
            <div class="game-card lg:col-span-2 p-5 flex flex-col">
                <h3 class="text-lg font-bold text-white mb-6 flex justify-between items-center tracking-wider">
                    <span class="flex items-center gap-3">
                        <span class="w-1 h-4 bg-blue-500 shadow-[0_0_8px_#3b82f6]"></span>
                        BATTLEFIELD STATUS
                    </span>
                    <!-- Pipeline Summary Here -->
                    <span class="text-sm text-slate-400 font-mono">
                        PIPELINE TOTAL: <span class="text-blue-400 neon-text">¬• {{ formatWan(stats.funnel?.total_pipeline_amount) }} ‰∏á</span>
                        <span class="mx-2 text-slate-600">|</span>
                        UNITS: <span class="text-blue-400">{{ stats.funnel?.total_count }}</span>
                    </span>
                </h3>
                <div class="flex-1 flex flex-col md:flex-row gap-4">
                    <!-- Completion Rate Gauge -->
                    <div id="gaugeChart" class="w-full md:w-1/3 h-64 md:h-full"></div>
                    <!-- Funnel -->
                    <div id="funnelChart" class="w-full md:w-2/3 h-64 md:h-full"></div>
                </div>
            </div>

            <!-- Right: Live Feed -->
            <div class="game-card lg:col-span-1 p-0 flex flex-col overflow-hidden">
                <div class="p-5 border-b border-slate-700 bg-slate-800/30 flex justify-between items-center">
                    <h3 class="text-lg font-bold text-white flex items-center gap-3 tracking-wider">
                        <span class="w-1 h-4 bg-amber-500 shadow-[0_0_8px_#f59e0b]"></span>
                        LIVE INTEL
                    </h3>
                    <!-- Carousel Stat -->
                    <div class="text-xs font-mono text-slate-400 text-right">
                        <div class="text-amber-500">{{ currentNewStat.label }}</div>
                        <div class="text-xl font-bold text-white">{{ currentNewStat.value }}</div>
                    </div>
                </div>
                
                <div class="flex-1 feed-scroll-wrapper" ref="feedWrapper">
                    <div class="feed-scroll-content space-y-3" ref="feedContent" :style="{ transform: `translateY(-${scrollTop}px)` }">
                        <div v-for="(log, index) in activities" :key="log.id" 
                             class="p-3 rounded border-l-2 bg-slate-800/40 hover:bg-slate-700/50 transition-all group relative overflow-hidden" 
                             :class="getBorderColor(log.action)">
                            <!-- Background Flash for key events -->
                            <div v-if="isMajorEvent(log.action)" class="absolute inset-0 bg-gradient-to-r from-transparent via-white/5 to-transparent animate-pulse pointer-events-none"></div>
                            
                            <div class="flex justify-between items-start mb-1 relative z-10">
                                <div class="flex items-center gap-2">
                                    <span class="font-bold text-slate-200 text-sm group-hover:text-white">{{ log.operator_name }}</span>
                                    <span class="text-[10px] px-1.5 py-0.5 bg-slate-700/50 text-slate-400 rounded border border-slate-600 font-mono">{{ formatTime(log.created_at) }}</span>
                                </div>
                                <!-- Icon -->
                                <div v-if="getEventIcon(log.action)" class="text-lg filter drop-shadow-[0_0_5px_rgba(255,255,255,0.5)]">
                                    {{ getEventIcon(log.action) }}
                                </div>
                            </div>
                            <div class="text-sm text-slate-400 group-hover:text-slate-300 relative z-10">
                                <span class="font-bold" :class="getTextColor(log.action)">[{{ log.action }}]</span> 
                                <span>{{ log.content }}</span>
                            </div>
                        </div>
                        
                        <!-- Clone for infinite scroll -->
                        <div v-if="activities.length > 5" class="border-t border-dashed border-slate-700 my-4 pt-4 opacity-30"></div>
                         <div v-if="activities.length > 5" v-for="(log, index) in activities" :key="'clone-'+log.id" 
                             class="p-3 rounded border-l-2 bg-slate-800/40 hover:bg-slate-700/50 transition-all group relative overflow-hidden" 
                             :class="getBorderColor(log.action)">
                            <div v-if="isMajorEvent(log.action)" class="absolute inset-0 bg-gradient-to-r from-transparent via-white/5 to-transparent animate-pulse pointer-events-none"></div>
                            <div class="flex justify-between items-start mb-1 relative z-10">
                                <div class="flex items-center gap-2">
                                    <span class="font-bold text-slate-200 text-sm group-hover:text-white">{{ log.operator_name }}</span>
                                    <span class="text-[10px] px-1.5 py-0.5 bg-slate-700/50 text-slate-400 rounded border border-slate-600 font-mono">{{ formatTime(log.created_at) }}</span>
                                </div>
                                <div v-if="getEventIcon(log.action)" class="text-lg filter drop-shadow-[0_0_5px_rgba(255,255,255,0.5)]">
                                    {{ getEventIcon(log.action) }}
                                </div>
                            </div>
                            <div class="text-sm text-slate-400 group-hover:text-slate-300 relative z-10">
                                <span class="font-bold" :class="getTextColor(log.action)">[{{ log.action }}]</span> 
                                <span>{{ log.content }}</span>
                            </div>
                        </div>

                        <div v-if="activities.length === 0" class="text-center text-slate-600 mt-10 font-mono text-xs tracking-widest">
                            // NO ACTIVITY DETECTED //
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global Error Handler
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            document.getElementById('error-layer').style.display = 'block';
            document.getElementById('error-message').innerText = `Error: ${msg}\nLine: ${lineNo}\nURL: ${url}\nStack: ${error?.stack}`;
            return false;
        };

        const { createApp, ref, onMounted, computed, watch, onUnmounted } = Vue;

        createApp({
            setup() {
                const currentTheme = ref(localStorage.getItem('dashboard_theme') || 'cyberpunk');
                document.body.className = `theme-${currentTheme.value}`;
                const currentThemeClass = computed(() => `theme-${currentTheme.value}`);

                watch(currentTheme, (val) => {
                    localStorage.setItem('dashboard_theme', val);
                    document.body.className = `theme-${val}`;
                    setTimeout(updateCharts, 100);
                });

                // State
                const stats = ref({
                    funnel: {},
                    financials: {}, // Updated structure
                    stages: [],
                    new_counts: {}
                });
                const activities = ref([]);
                const currentTime = ref('');
                
                // Departments (L2) - Removed RND as requested
                const departmentTags = [
                    { name: 'ÈîÄÂîÆÈÉ®', code: 'SALES' },
                    { name: 'Êò•ÁßãGAME', code: 'GAME' },
                    { name: 'ÈõÜÂõ¢Â∏ÇÂú∫ÈÉ®', code: 'GROUP_MARKETING' },
                    { name: 'Ê†áÂáÜÂÆûË∑µÂÆûÈ™åÂÆ§', code: 'LAB' }
                ];
                const currentDeptIndex = ref(0);
                const isDeptLocked = ref(false);

                // New Stats Carousel
                const newStatsOptions = ['today', 'week', 'month', 'quarter', 'year'];
                const newStatsLabels = {
                    'today': '‰ªäÊó•Êñ∞Â¢û',
                    'week': 'Êú¨Âë®Êñ∞Â¢û',
                    'month': 'Êú¨ÊúàÊñ∞Â¢û',
                    'quarter': 'Êú¨Â≠£Êñ∞Â¢û',
                    'year': '‰ªäÂπ¥Êñ∞Â¢û'
                };
                const currentNewStatIndex = ref(0);

                // Scroll
                const scrollTop = ref(0);
                const feedWrapper = ref(null);
                const feedContent = ref(null);
                let scrollInterval = null;

                // Charts
                let gaugeChart = null;
                let funnelChart = null;
                let lastLogId = 0;

                // API Base
                const getApiBase = () => {
                    const hostname = window.location.hostname;
                    if (!hostname) {
                        return 'http://127.0.0.1:8000';
                    }
                    return `http://${hostname}:8000`;
                };
                const adminUrl = computed(() => `${getApiBase()}/admin/`);

                // Computed
                const currentNewStat = computed(() => {
                    const key = newStatsOptions[currentNewStatIndex.value];
                    const val = stats.value.new_counts ? stats.value.new_counts[key] : 0;
                    return {
                        label: newStatsLabels[key],
                        value: val
                    };
                });

                // Formatters
                const formatWan = (num) => {
                    if (!num) return '0';
                    // Backend is Yuan, Display is Wan (Divide by 10000)
                    return (Number(num) / 10000).toLocaleString(undefined, { minimumFractionDigits: 1, maximumFractionDigits: 2 });
                };

                const formatTime = (timeStr) => {
                    if (!timeStr) return '';
                    try {
                        const date = new Date(timeStr);
                        return date.toLocaleTimeString('zh-CN', { hour12: false });
                    } catch (e) { return timeStr; }
                };

                // Styles & Visuals
                const isMajorEvent = (action) => {
                    if (!action) return false;
                    return ['Ëµ¢Âçï', '‰∏≠Ê†á', 'Á≠æÂêàÂêå', 'Á≠æÁ∫¶', '‰∫§‰ªò', 'ÂÆåÊàê'].some(k => action.includes(k));
                };

                const getEventIcon = (action) => {
                    if (!action) return '';
                    if (action.includes('Ëµ¢Âçï') || action.includes('‰∏≠Ê†á')) return 'üèÜ';
                    if (action.includes('Á≠æÂêàÂêå') || action.includes('Á≠æÁ∫¶')) return '‚úçÔ∏è';
                    if (action.includes('‰∫§‰ªò') || action.includes('ÂÆåÊàê')) return 'üöÄ';
                    if (action.includes('ËæìÂçï')) return 'üíî';
                    if (action.includes('ÂàõÂª∫')) return '‚ú®';
                    return '';
                };

                const getBorderColor = (action) => {
                    if (!action) return 'border-blue-500/50';
                    if (action.includes('Ëµ¢Âçï') || action.includes('‰∏≠Ê†á')) return 'border-yellow-500/50 bg-yellow-900/20';
                    if (action.includes('Á≠æÂêàÂêå') || action.includes('Á≠æÁ∫¶')) return 'border-green-500/50 bg-green-900/20';
                    if (action.includes('‰∫§‰ªò') || action.includes('ÂÆåÊàê')) return 'border-cyan-500/50 bg-cyan-900/20';
                    if (action.includes('ËæìÂçï')) return 'border-red-500/50 bg-red-900/10';
                    return 'border-blue-500/50';
                };
                
                const getTextColor = (action) => {
                    if (!action) return 'text-blue-400';
                    if (action.includes('Ëµ¢Âçï') || action.includes('‰∏≠Ê†á')) return 'neon-gold font-black';
                    if (action.includes('Á≠æÂêàÂêå') || action.includes('Á≠æÁ∫¶')) return 'neon-green font-black';
                    if (action.includes('‰∫§‰ªò') || action.includes('ÂÆåÊàê')) return 'neon-cyan font-black';
                    if (action.includes('ËæìÂçï')) return 'text-red-400';
                    if (action.includes('ÂàõÂª∫')) return 'text-white';
                    return 'text-blue-400';
                };

                // Audio (Epic Victory Chime)
                const playSound = (type = 'normal') => {
                    try {
                        const AudioContext = window.AudioContext || window.webkitAudioContext;
                        if (!AudioContext) return;
                        const ctx = new AudioContext();
                        const t = ctx.currentTime;

                        const playNote = (freq, time, duration, type='sawtooth') => {
                            const osc = ctx.createOscillator();
                            const gain = ctx.createGain();
                            osc.type = type;
                            osc.frequency.value = freq;
                            
                            gain.gain.setValueAtTime(0, time);
                            gain.gain.linearRampToValueAtTime(0.1, time + 0.05);
                            gain.gain.exponentialRampToValueAtTime(0.001, time + duration);
                            
                            osc.connect(gain);
                            gain.connect(ctx.destination);
                            osc.start(time);
                            osc.stop(time + duration);
                        };

                        if (type === 'major') {
                            // Major Chord for Victory/Sign
                            playNote(523.25, t, 0.4); // C5
                            playNote(659.25, t + 0.1, 0.4); // E5
                            playNote(783.99, t + 0.2, 0.6); // G5
                            playNote(1046.50, t + 0.4, 1.5, 'sine'); // C6
                        } else {
                            // Simple Ping for update
                            playNote(880, t, 0.2, 'sine');
                        }

                    } catch (e) { console.warn('Audio failed', e); }
                };

                // Fetch Data
                const fetchData = async () => {
                    try {
                        // Use Token Authentication for better security
                        // Token for user: daping
                        const authHeader = { 'Authorization': 'Token c1f3b1091482b6ce8ab47d5a500bc183c43c7dce' };
                        const API_BASE = getApiBase();
                        
                        // Params
                        const currentDept = departmentTags[currentDeptIndex.value];
                        const params = {};
                        if (currentDept.code) {
                            params.department = currentDept.code;
                        }

                        // 1. Stats
                        const response = await axios.get(`${API_BASE}/api/dashboard/stats/`, { 
                            headers: authHeader,
                            params: params 
                        });
                        if (response.data) {
                            stats.value = response.data;
                            updateCharts();
                        }

                        // 2. Activities
                        const logsRes = await axios.get(`${API_BASE}/api/dashboard/activities/`, { headers: authHeader });
                        const newLogs = logsRes.data || [];
                        
                        if (newLogs.length > 0 && activities.value.length > 0) {
                            if (newLogs[0].id > lastLogId) {
                                const action = newLogs[0].action;
                                if (isMajorEvent(action)) {
                                    playSound('major');
                                } else {
                                    playSound('normal');
                                }
                            }
                        }
                        if (newLogs.length > 0) {
                            lastLogId = newLogs[0].id;
                        }
                        activities.value = newLogs;

                    } catch (error) {
                        console.error('Failed to fetch data:', error);
                    }
                };

                // Charts Update
                const updateCharts = () => {
                    if (!gaugeChart || !funnelChart) return;
                    
                    // Completion Rate: Actual Signed / Target Signed
                    const actual = stats.value.financials?.actual_signed || 0;
                    const target = stats.value.financials?.target_signed || 1; // Avoid div by zero
                    let rate = (actual / target) * 100;
                    if (rate > 100) rate = 100; // Cap at 100 for gauge visual (or let it go over?)
                    // Let's cap at 100 for visual gauge, but display real value if needed. 
                    // Actually, exceeding 100% is good. ECharts handles it.

                    const isLight = currentTheme.value === 'saas';
                    
                    // Gauge: Sci-fi Style
                    gaugeChart.setOption({
                        series: [{
                            type: 'gauge',
                            startAngle: 180,
                            endAngle: 0,
                            min: 0,
                            max: 100, // Target is 100%
                            splitNumber: 5,
                            itemStyle: { 
                                color: '#3b82f6',
                                shadowBlur: isLight ? 0 : 10,
                                shadowColor: '#3b82f6'
                            },
                            progress: { show: true, width: 8 },
                            pointer: { show: false },
                            axisLine: { lineStyle: { width: 8, color: [[1, isLight ? '#e2e8f0' : '#1e293b']] } },
                            axisTick: { show: false },
                            splitLine: { length: 12, lineStyle: { width: 2, color: isLight ? '#cbd5e1' : '#475569' } },
                            axisLabel: { color: isLight ? '#64748b' : '#64748b', fontSize: 10, distance: -20 },
                            detail: {
                                valueAnimation: true,
                                offsetCenter: [0, '-20%'],
                                fontSize: 40,
                                fontWeight: 'bolder',
                                formatter: '{value}%',
                                color: isLight ? '#0f172a' : '#fff',
                                textShadowBlur: isLight ? 0 : 10,
                                textShadowColor: '#3b82f6'
                            },
                            data: [{ value: rate.toFixed(1) }]
                        }]
                    });

                    // Funnel: Hologram Style
                    const funnelData = (stats.value.stages || []).map(s => ({
                        value: s.count,
                        name: s.stage
                    }));

                    funnelChart.setOption({
                        tooltip: { 
                            trigger: 'item', 
                            formatter: '{b} : {c}',
                            backgroundColor: 'rgba(15, 23, 42, 0.9)',
                            borderColor: '#3b82f6',
                            textStyle: { color: '#fff' }
                        },
                        color: ['#3b82f6', '#60a5fa', '#93c5fd', '#bfdbfe', '#dbeafe'],
                        series: [{
                            name: 'ÂïÜÊú∫ÊºèÊñó',
                            type: 'funnel',
                            left: '10%',
                            top: 10,
                            bottom: 10,
                            width: '80%',
                            min: 0,
                            max: 10,
                            minSize: '0%',
                            maxSize: '100%',
                            sort: 'descending',
                            gap: 2,
                            label: { show: true, position: 'inside', color: '#0f172a', fontWeight: 'bold' },
                            itemStyle: { 
                                borderColor: isLight ? '#fff' : '#0f172a', 
                                borderWidth: 2,
                                opacity: 0.8
                            },
                            emphasis: { 
                                label: { fontSize: 16 },
                                itemStyle: { opacity: 1 }
                            },
                            data: funnelData
                        }]
                    });
                };

                // Department Logic
                const lockDepartment = (index) => {
                    if (currentDeptIndex.value === index) {
                        isDeptLocked.value = !isDeptLocked.value; 
                    } else {
                        currentDeptIndex.value = index;
                        isDeptLocked.value = true;
                        fetchData();
                    }
                };

                // Init
                onMounted(() => {
                    setInterval(() => {
                        const now = new Date();
                        currentTime.value = now.toLocaleTimeString('en-GB');
                    }, 1000);

                    setInterval(() => {
                        if (!isDeptLocked.value) {
                            currentDeptIndex.value = (currentDeptIndex.value + 1) % departmentTags.length;
                            fetchData();
                        }
                        currentNewStatIndex.value = (currentNewStatIndex.value + 1) % newStatsOptions.length;
                    }, 5000);

                    scrollInterval = setInterval(() => {
                        // Only scroll if we have enough content (more than 5 items)
                        // And verify we actually have the elements rendered
                        if (feedWrapper.value && feedContent.value && activities.value.length > 0) {
                            scrollTop.value += 0.5; // Slower scroll for better readability
                            
                            // The content is duplicated in the template with v-for="... in activities" and then again for "clone"
                            // So the total scrollable height is roughly 2 * original_height
                            // We reset when we've scrolled past the first set
                            const singleSetHeight = feedContent.value.scrollHeight / 2;
                            
                            if (scrollTop.value >= singleSetHeight) {
                                scrollTop.value = 0;
                            }
                        }
                    }, 50);

                    setTimeout(() => {
                        const gaugeEl = document.getElementById('gaugeChart');
                        const funnelEl = document.getElementById('funnelChart');
                        if (gaugeEl && funnelEl) {
                            gaugeChart = echarts.init(gaugeEl);
                            funnelChart = echarts.init(funnelEl);
                            window.addEventListener('resize', () => {
                                gaugeChart && gaugeChart.resize();
                                funnelChart && funnelChart.resize();
                            });
                        }
                        fetchData();
                    }, 100);
                    
                    setInterval(fetchData, 10000);
                });

                onUnmounted(() => {
                    if (scrollInterval) clearInterval(scrollInterval);
                });

                return {
                    stats,
                    activities,
                    currentTime,
                    adminUrl,
                    departmentTags,
                    currentDeptIndex,
                    lockDepartment,
                    currentNewStat,
                    scrollTop,
                    feedWrapper,
                    feedContent,
                    formatWan,
                    formatTime,
                    getBorderColor,
                    getTextColor,
                    getEventIcon,
                    isMajorEvent,
                    currentTheme,
                    currentThemeClass
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
