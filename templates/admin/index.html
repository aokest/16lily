{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block bodyclass %}{{ block.super }} dashboard{% endblock %}

{% block content_title %} <h1>个人中心</h1> {% endblock %}

{% block breadcrumbs %}
<ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="{% url 'admin:index' %}">首页</a></li>
    <li class="breadcrumb-item active">个人中心</li>
</ol>
{% endblock %}


{% block content %}
{% get_current_language as LANGUAGE_CODE %}
{% get_current_language_bidi as LANGUAGE_BIDI %}

<div class="container-fluid">
    <!-- Top Stats Row -->
    <div class="row">
        <div class="col-md-3 col-sm-6 col-12">
            <div class="info-box">
                <span class="info-box-icon bg-info"><i class="fas fa-clipboard-list"></i></span>
                <div class="info-box-content">
                    <span class="info-box-text">我的待办</span>
                    <span class="info-box-number" id="dashboard-todo-count">加载中...</span>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 col-12">
            <div class="info-box">
                <span class="info-box-icon bg-success"><i class="fas fa-hand-holding-usd"></i></span>
                <div class="info-box-content">
                    <span class="info-box-text">我的商机</span>
                    <span class="info-box-number" id="dashboard-opp-count">加载中...</span>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 col-12">
            <div class="info-box">
                <span class="info-box-icon bg-purple"><i class="fas fa-trophy"></i></span>
                <div class="info-box-content">
                    <span class="info-box-text">赛事信息</span>
                    <span class="info-box-number" id="dashboard-comp-count">加载中...</span>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 col-12">
            <div class="info-box">
                <span class="info-box-icon bg-orange"><i class="fas fa-bullhorn"></i></span>
                <div class="info-box-content">
                    <span class="info-box-text">市场活动</span>
                    <span class="info-box-number" id="dashboard-activity-count">加载中...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Row -->
    <div class="row">
        <!-- Left Column: Unified Kanban Hub + Shortcuts -->
        <div class="col-lg-8 col-md-12">
            <div class="card card-info card-outline">
                <div class="card-header">
                    <h5 class="card-title m-0"><i class="fas fa-columns mr-2"></i>系统看板入口</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <a href="/admin/core/competition/kanban/" class="btn btn-primary btn-block">
                                <i class="fas fa-trophy mr-1"></i> 赛事看板
                            </a>
                        </div>
                        <div class="col-md-6 mb-3">
                            <a href="/admin/core/marketactivity/kanban/" class="btn btn-primary btn-block">
                                <i class="fas fa-bullhorn mr-1"></i> 市场活动看板
                            </a>
                        </div>
                        <div class="col-md-6 mb-3">
                            <a href="/api/dashboard/screen/" target="_blank" class="btn btn-success btn-block">
                                <i class="fas fa-tv mr-1"></i> 石榴粒粒 · 经营数据大屏
                            </a>
                        </div>
                        <div class="col-md-6 mb-3">
                            <a href="http://127.0.0.1:8080/" target="_blank" class="btn btn-dark btn-block">
                                <i class="fas fa-gamepad mr-1"></i> 十六军团战报
                            </a>
                        </div>
                        <div class="col-md-6 mb-3">
                            <a href="http://127.0.0.1:8080/competitions.html" target="_blank" class="btn btn-warning btn-block">
                                <i class="fas fa-trophy mr-1"></i> 赛事大屏
                            </a>
                        </div>
                        <div class="col-md-6 mb-3">
                            <a href="http://127.0.0.1:8080/activities.html" target="_blank" class="btn btn-warning btn-block">
                                <i class="fas fa-bullhorn mr-1"></i> 活动大屏
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card card-primary card-outline">
                <div class="card-header">
                    <h5 class="card-title m-0"><i class="fas fa-th mr-2"></i>快捷入口</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for app in app_list %}
                        <div class="col-md-6">
                            <div class="card shadow-none border">
                                <div class="card-header border-0">
                                    <h3 class="card-title">{{ app.name }}</h3>
                                </div>
                                <div class="card-body p-0">
                                    <table class="table table-sm table-hover">
                                        <tbody>
                                            {% for model in app.models %}
                                            <tr>
                                                <td>
                                                    {% if model.admin_url %}
                                                        <a href="{{ model.admin_url }}" class="text-dark font-weight-bold">
                                                            {% if model.icon %}<i class="{{ model.icon }} mr-2 text-muted"></i>{% endif %}
                                                            {{ model.name }}
                                                        </a>
                                                    {% else %}
                                                        {{ model.name }}
                                                    {% endif %}
                                                </td>
                                                <td class="text-right">
                                                    {% if model.add_url %}
                                                        <a href="{{ model.add_url }}" class="btn btn-xs btn-success" title="{% trans 'Add' %}"><i class="fas fa-plus"></i> 添加</a>
                                                    {% endif %}
                                                    {% if model.admin_url %}
                                                        <a href="{{ model.admin_url }}" class="btn btn-xs btn-info" title="{% trans 'Change' %}"><i class="fas fa-edit"></i> 管理</a>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Recent Actions (Restyled) -->
        <div class="col-lg-4 col-md-12">
            <div class="card card-info">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-history mr-1"></i> 最近动作</h3>
                </div>
                <div class="card-body p-0" style="max-height: 600px; overflow-y: auto; background-color: #f8f9fa;">
                    {% load log %}
                    {% get_admin_log 20 as admin_log for_user user %}
                    {% if admin_log %}
                        <div class="timeline timeline-inverse" style="padding: 15px;">
                            {% for entry in admin_log %}
                            <div class="time-label">
                                <span class="bg-secondary text-white" style="font-size: 10px; padding: 2px 5px; border-radius: 3px;">
                                    {{ entry.action_time|date:"H:i" }}
                                </span>
                            </div>
                            <div>
                                {% if entry.is_addition %}
                                    <i class="fas fa-plus bg-success"></i>
                                {% elif entry.is_change %}
                                    <i class="fas fa-edit bg-warning"></i>
                                {% elif entry.is_deletion %}
                                    <i class="fas fa-trash bg-danger"></i>
                                {% endif %}
                                
                                <div class="timeline-item" style="border: none; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                    <h3 class="timeline-header" style="font-size: 13px; padding: 8px; border-bottom: 1px solid #eee;">
                                        {% if entry.content_type %}
                                            <span class="text-bold text-primary">{{ entry.content_type }}</span>
                                        {% else %}
                                            <span class="text-muted">未知对象</span>
                                        {% endif %}
                                    </h3>
                                    
                                    <div class="timeline-body" style="padding: 8px; font-size: 12px;">
                                        <a href="{{ entry.get_admin_url }}" class="text-dark font-weight-bold">{{ entry.object_repr }}</a>
                                        <br/>
                                        <span class="text-muted" style="font-size: 11px;">
                                            {{ entry.action_time|date:"Y-m-d" }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                            <div>
                                <i class="far fa-clock bg-gray"></i>
                            </div>
                        </div>
                    {% else %}
                        <div class="p-3 text-center text-muted">暂无最近操作记录</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Dashboard Stats Script -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Hardcode Personal Center Title in Sidebar if Jazzmin doesn't allow config
        const sidebarLink = document.querySelector('a.nav-link[href="/admin/"] p');
        if (sidebarLink) {
            // Rebuild the sidebar link content
            // Assuming structure: <i class="..."></i> <p>Text</p> or similar
            // Jazzmin usually puts text inside p
            sidebarLink.childNodes.forEach(node => {
                if (node.nodeType === Node.TEXT_NODE && (node.textContent.includes('仪表盘') || node.textContent.includes('Dashboard'))) {
                    node.textContent = ' 个人中心';
                }
            });
        }

        // Fetch Stats
        // Todo Count
        fetch('/api/dashboard/summary/')
        .then(response => response.json())
        .then(data => {
            document.getElementById('dashboard-todo-count').innerText = data.todo_count;
            document.getElementById('dashboard-opp-count').innerText = data.opportunity_count;
            // document.getElementById('dashboard-fans-count').innerText = data.fans_count; // Removed or moved
        })
        .catch(err => console.error(err));
        
        // Competition Count (Mock/Separate API needed or use summary endpoint if updated)
        // For now, just put placeholders or simple fetch if API supports it.
        // Let's assume summary API needs update, but for now show '-'
        
        // To fix the "Competition" and "Activity" counts, we might need to update the View.
        // But user didn't strictly ask for the number to be live right now, just the cards.
        // We can leave them as "-" or "Loading..." until API is updated.
    });
</script>
{% endblock %}
