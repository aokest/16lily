{% extends "admin/change_form.html" %}
{% load i18n admin_urls static %}

{% block form_top %}
<div class="row mb-4">
    <div class="col-12">
        <div class="ai-chat-container">
            <div class="ai-chat-header">
                <i class="fas fa-robot"></i> AI æ™ºèƒ½å¡«æŠ¥åŠ©æ‰‹ (Beta)
                <span style="font-size: 0.8em; opacity: 0.8; margin-left: 10px;">
                    è¾“å…¥å·¥ä½œå†…å®¹ï¼ŒAIè‡ªåŠ¨ç”ŸæˆæŠ¥å‘Šã€æ‘˜è¦å¹¶åˆ†ç±»ã€‚
                </span>
            </div>
            
            <div id="chat-messages" class="ai-chat-messages">
                <div class="ai-message assistant">
                    ğŸ‘‹ ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„æ™ºèƒ½å·¥ä½œåŠ©ç†ã€‚
                    <br>è¯·å‘Šè¯‰æˆ‘ä½ ä»Šå¤©åšäº†ä»€ä¹ˆï¼Ÿä¾‹å¦‚ï¼š
                    <br><em>"ä»Šå¤©ä¸Šåˆå»æ‹œè®¿äº†å¼ æ€»ï¼Œç¡®è®¤äº†Aé¡¹ç›®çš„éœ€æ±‚ï¼Œä¸‹åˆå†™äº†æ–¹æ¡ˆï¼Œæ˜å¤©å‡†å¤‡å‘ç»™å®¢æˆ·ã€‚"</em>
                </div>
            </div>
            
            <div class="ai-input-area">
                <textarea id="chat-input" rows="2" placeholder="åœ¨æ­¤è¾“å…¥å·¥ä½œå†…å®¹... (æ”¯æŒå¤šè¡Œ, Enteræ¢è¡Œ, Ctrl+Enterå‘é€)"></textarea>
                <button type="button" id="btn-send" class="btn btn-primary">
                    <i class="fas fa-paper-plane"></i> ç”Ÿæˆ
                </button>
            </div>
            
            <!-- Suggestions Area (Hidden by default) -->
            <div id="ai-suggestions" style="display:none; padding: 10px 15px; background: #fff3cd; border-top: 1px solid #ffeeba;">
                <strong>ğŸ’¡ ä¸‹ä¸€æ­¥å»ºè®®:</strong>
                <ul id="next-steps-list" style="margin-bottom: 0; padding-left: 20px;"></ul>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatInput = document.getElementById('chat-input');
    const btnSend = document.getElementById('btn-send');
    const messagesContainer = document.getElementById('chat-messages');
    const suggestionsBox = document.getElementById('ai-suggestions');
    const nextStepsList = document.getElementById('next-steps-list');
    
    // Field References
    const fieldContent = document.getElementById('id_content');
    const fieldSummary = document.getElementById('id_ai_summary');
    const fieldType = document.getElementById('id_type');
    const fieldRaw = document.getElementById('id_ai_raw_input'); // If exists

    function addMessage(text, sender) {
        const div = document.createElement('div');
        div.className = 'ai-message ' + sender;
        div.innerHTML = text.replace(/\n/g, '<br>');
        messagesContainer.appendChild(div);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    async function analyzeText(text) {
        // Show loading
        btnSend.disabled = true;
        btnSend.innerHTML = '<i class="fas fa-spinner fa-spin"></i> åˆ†æä¸­...';
        
        try {
            const response = await fetch('/api/ai/analyze/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    text: text,
                    mode: 'WORK_REPORT'
                })
            });
            
            const data = await response.json();
            
            if (data.error) {
                addMessage('âŒ åˆ†æå¤±è´¥: ' + data.error, 'assistant');
            } else {
                // Success: Fill fields
                if (data.content) {
                    if (fieldContent) fieldContent.value = data.content;
                }
                if (data.ai_summary) {
                    if (fieldSummary) fieldSummary.value = data.ai_summary;
                }
                if (data.report_type) {
                    if (fieldType) fieldType.value = data.report_type;
                }
                if (fieldRaw) {
                    fieldRaw.value = text; // Save raw input
                }
                
                // Show suggestions
                if (data.next_steps && data.next_steps.length > 0) {
                    suggestionsBox.style.display = 'block';
                    nextStepsList.innerHTML = data.next_steps.map(step => `<li>${step}</li>`).join('');
                    
                    addMessage('âœ… æŠ¥å‘Šå·²ç”Ÿæˆï¼\næˆ‘ä¹Ÿä¸ºä½ æ•´ç†äº†ä¸€äº›ä¸‹ä¸€æ­¥å»ºè®®ï¼Œè¯·æŸ¥çœ‹ä¸‹æ–¹ã€‚', 'assistant');
                } else {
                    addMessage('âœ… æŠ¥å‘Šå·²ç”Ÿæˆï¼è¯·æ£€æŸ¥ä¸‹æ–¹è¡¨å•ã€‚', 'assistant');
                }
            }
            
        } catch (error) {
            console.error(error);
            addMessage('âŒ ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•ã€‚', 'assistant');
        } finally {
            btnSend.disabled = false;
            btnSend.innerHTML = '<i class="fas fa-paper-plane"></i> ç”Ÿæˆ';
        }
    }

    btnSend.addEventListener('click', function() {
        const text = chatInput.value.trim();
        if (!text) return;
        
        addMessage(text, 'user');
        chatInput.value = '';
        analyzeText(text);
    });
    
    chatInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && e.ctrlKey) {
            btnSend.click();
        }
    });
});
</script>
{% endblock %}
