# 🚀 1Panel 云服务器自动化部署手册 (Alibaba Cloud)

本手册专为 **1Panel 面板** 环境设计，通过本地自动化脚本实现“一键部署”，并确保研发/生产环境的彻底隔离。

---

## 1. �️ 环境隔离与数据安全原则

在进行任何部署操作前，请务必理解以下原则：
- **代码同步，数据隔离**：部署脚本仅同步您的最新代码逻辑（业务逻辑、UI 界面、接口定义），**绝不会**同步本地的测试数据库（`db.sqlite3`）或本地环境变量（`.env`）。
- **云端纯净构建**：系统在云端会根据 `Dockerfile` 重新安装依赖并编译前端，确保运行环境的纯净性。
- **配置持久化**：云端的 `.env.prod` 文件一旦创建，除非手动修改，否则不会被部署脚本覆盖，确保生产环境的 API Key 和数据库密码安全。

---

## 2. � 干净的环境准备 (首次部署/重置)

如果您需要在一个全新的环境或想要彻底重置环境：
1. **清理旧文件**：
   ```bash
   rm -rf /opt/16lily/*  # 慎用！这会删除所有代码和配置
   ```
2. **准备配置文件**：
   在 `/opt/16lily` 下手动创建 `.env.prod`，内容参考项目根目录下的 `.env.prod.example`。
3. **开启 Swap**：参考本手册后续的性能优化章节。

---

## 3. ⚡ 自动化一键部署 (推荐方式)

这是最简单、最稳妥的日常维护方式。

### 3.1 部署流程
在您的**本地电脑**终端执行：
1. **修改脚本配置**：打开 `deploy.sh`，确保 `SERVER_IP` 正确。
2. **执行部署**：
   ```bash
   ./deploy.sh
   ```

### 3.2 脚本自动执行的动作
- **深度清洗**：自动剔除本地 `venv`、`node_modules`、测试数据库、日志文件和敏感配置。
- **增量同步**：仅上传压缩后的代码包到 `/opt/16lily`。
- **无缓存构建**：远程触发 `docker compose build`，确保代码更新立即生效。
- **自动迁移**：自动执行 `python manage.py migrate`，同步数据库表结构变化。

---

## 4. 🧹 数据清洗与维护

### 4.1 数据库同步 (Migrations)
当您修改了 Django 模型（Models）后，只需运行一次 `deploy.sh`，脚本会自动在容器内执行迁移命令。

### 4.2 清理过期数据
如果需要手动进入生产环境执行管理任务（如清理测试商机）：
1. 在 1Panel 容器列表中进入 `16lily-web-1` 的终端。
2. 执行管理命令：
   ```bash
   python manage.py shell  # 进入 Python 交互界面进行数据操作
   ```

### 4.3 重启容器
如果仅需重启服务（不更新代码）：
```bash
docker compose -f docker-compose.prod.yml restart
```

---

## 5. 🌡️ 2C/2G 性能优化建议

1. **Swap 虚拟内存**：必须开启 2G 以上的 Swap，否则构建前端时极易导致服务器假死。
2. **Nginx 托管**：目前已配置 Nginx 直接托管前端 `dist` 和后端静态文件，极大减轻了 Python 后端的压力。
3. **日志清理**：Docker 默认日志可能会占用大量空间，建议定期清理。

---

## 6. ❓ 常见问题

**Q: 为什么我本地的商机数据没有同步到服务器？**
A: 这是为了保护生产数据。部署脚本只负责更新“功能”和“界面”。如果您需要同步基础配置数据，建议使用 Django 的 `fixtures` 功能或手动在后台添加。

**Q: 部署后界面没变化？**
A: 脚本已配置 `up -d --build`，通常会自动更新。如果没变化，请尝试在浏览器中强刷页面（Ctrl+F5）以清除前端缓存。
