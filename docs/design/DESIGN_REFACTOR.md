
## 4. 系统重构设计 (Refactoring Design) - 2025/12/27

### 4.1 导航与布局重构
- **原则**: 区分“管理”与“业务”，区分“全员可见”与“角色专属”。
- **顶部栏**: 放置全局工具入口（战报大屏、CRM首页）。
- **侧边栏结构**:
    1.  **个人中心** (默认首页): 聚合目标、项目、待办、通知。
    2.  **AI中枢**: 对话窗口。
    3.  **经营管理**: 业绩报表、商机、审批 (全员可见，编辑受限)。
    4.  **客户管理**: 客户、联系人 (仅销售可见)。
    5.  **社媒管理**: 账号列表 (含粉丝数据) (全员可见，市场部编辑)。
    6.  **系统配置**: 用户、AI、迁移 (仅管理员可见)。

### 4.2 数据权限与隔离设计 (Data Isolation & RBAC)
基于“最小权限原则”与“业务灵活性”的设计方案：

#### A. 数据分类分级
1.  **私有数据 (Private)**:
    -   **定义**: 仅用户自己可见。
    -   **范围**: 个人AI配置 (`AIConfiguration.user != null`)、个人草稿、个人待办。
2.  **层级数据 (Hierarchical)**:
    -   **定义**: 用户可见自己 + 所有下属的数据。
    -   **范围**: 商机 (`Opportunity`)、客户 (`Customer`)、业绩目标 (`PerformanceTarget`)。
    -   **实现**: `UserProfile.reports_to` 字段构建汇报树。查询时递归获取下属 ID 列表。
3.  **部门数据 (Departmental)**:
    -   **定义**: 同部门可见 (可选)。
    -   **范围**: 部门公告、部门内部文档。
4.  **公共数据 (Public/Read-only)**:
    -   **定义**: 全员可见，特定角色可编辑。
    -   **范围**: 经营数据概览、社媒账号公开信息、系统公告。

#### B. 角色权限矩阵
| 角色 | 经营管理 | 客户管理 | 社媒管理 | 系统配置 | 数据范围 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **系统管理员** | 读写 | 读写 | 读写 | **完全控制** | 全局数据 |
| **总经理/总监** | 读写 | 读写 | 读 | 不可见 | 本人 + 下属数据 |
| **销售经理** | 读写 | 读写 | 读 | 不可见 | 本人 + 下属数据 |
| **销售人员** | 读写(部分) | 读写 | 读 | 不可见 | 仅本人数据 |
| **市场人员** | 读 | 不可见 | **读写(需审批)** | 不可见 | 社媒数据 + 公共数据 |
| **普通员工** | 读 | 不可见 | 读 | 不可见 | 仅本人相关 |

#### C. AI 配置隔离策略
-   **系统级配置**: `user=NULL`。所有用户默认可用，但不可修改 API Key。
-   **用户级配置**: `user=Current_User`。用户可添加自己的 Key (如 OpenAI/DeepSeek)，数据加密存储，仅自己可见。
-   **优先级**: 优先使用用户配置，无则回退到系统默认配置。
