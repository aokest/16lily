# 项目追踪 (Project Tracking)

> **版本**: v1.0.0
> **最后更新日期**: 2026-01-04
> **状态**: 核心修复与功能深化阶段 (v1.0.1 迭代中)

## 1. 项目初衷 (Original Intention)
打造一个“数字化作战指挥中心”，打破部门壁垒，让每一个角色的贡献都被看见。通过集成 CRM、项目管理、社媒管理与业绩统计，实现全流程的业务闭环。

## 2. 核心目标 (Core Goals)
- **业务闭环**: 从线索 -> 商机 -> 项目 -> 回款的全生命周期管理。
- **数据透明**: 实时可视化的业绩报表与社媒数据统计。
- **AI 赋能**: 利用 AI 辅助日报撰写、商机分析与数据填报。
- **易用性**: 针对非技术人员友好的操作界面与交互体验。

## 3. 当前规划 (Current Planning)
目前处于 **Phase 2 (核心业务完善与稳定性修复)** 阶段。
重点在于：
- 确保所有核心业务 API (商机、客户、报表) 的稳定性。
- 完善社媒管理功能与数据统计。
- 引入“工作日报”功能，连接个人工作与项目/商机进展。

## 4. 项目进展 (Progress Overview)

### ✅ 已完成 (Completed)
- **环境同步与代码健壮性优化 (2026-01-05)**:
    - 同步本地与生产环境的 `init_roles.py`，移除过时的模型引用，确保初始化流程在两端都能顺利运行。
    - 验证并固化前端 `package.json` 的构建配置，默认跳过 `vue-tsc` 类型检查以确保部署成功率。
    - 统一本地开发环境与生产环境的核心业务逻辑修复。
- **1Panel 生产环境部署 (2026-01-05)**:
    - 成功在 1Panel 环境下通过 Docker Compose 启动全栈服务（Nginx, Vue Frontend, Django Backend, PostgreSQL）。
    - 修复了 Docker 构建过程中的 TypeScript 类型检查与 npm 构建错误。
    - 配置了 Nginx 反向代理，实现了前后端同端口访问（80 端口）。
    - 优化了部署流程，支持一键 `up -d --build` 自动恢复。
- **本地后端稳定性修复 (v1.0.1)**:
    - 彻底移除 `SocialMediaAdmin` 相关无效模型引用，解决 `ImportError` 导致的后端崩溃。
    - 验证并恢复本地数据访问，修复前端“获取失败”报错。
- **API 通讯与路径修复 (v1.0.2)**:
    - 修复前端所有 `api.get/post` 调用中的前导斜杠 (Leading Slashes) 问题，解决 Vite 代理失效导致的 404/500 错误。
    - 在 `PersonalCenter.vue` 和 `ProjectList.vue` 中引入更健壮的用户获取逻辑，增加 `users/simple/` 与 `admin/users/` 的自动回退机制。
    - 修复 `GlobalTimeline.vue` 和 `api/dailyReports.ts` 中的 API 请求路径。
- **部门与审批数据修复**:
    - 补全 `DepartmentModel` 的后端接口：新增 `DepartmentSerializer`, `DepartmentViewSet` 并完成路由注册，解决前端获取部门列表失败的问题。
    - 优化 `ApprovalRequestSerializer`，增加 `applicant_name` 等显示字段，确保个人中心审批流显示正常。
- **UI/UX 同步优化**:
    - 在 `PersonalCenter.vue` 中增加数据监听器 (Watchers)，确保异步加载数据后 Lucide 图标能正确渲染。
    - 优化 `PersonalCenter.vue` 的 `onMounted` 钩子，确保所有核心数据（项目、日报、审批、消息）在页面加载时同步获取。
- **日报系统深度优化 (v1.0.0)**: 
    - 修复 `@` 提及功能的前端选中交互问题 (Element Plus 兼容性)。
    - 优化后端通知触发逻辑，强制同步 M2M 关系，确保艾特通知 100% 送达。
    - 调整通知类型与前端映射，使提及消息能准确出现在“个人中心-通知消息”列表中并带有专属标签。
- **API 稳定性修复**:
    - 修复 `Opportunities` Endpoint 500 错误 (移除不存在的 `project_manager` 字段)。
    - 修复 `Social Accounts` Endpoint 500 错误 (清理无效的筛选字段)。
    - 修复 `Performance Report` 聚合统计错误 (字段映射修正)。
    - 修复 `Contacts` 与 `Customers` 列表获取失败问题。
    - 解决 User Profile 序列化时的空指针异常。
- **功能增强**:
    - 实现“工作日报”前端页面 (列表、日历、编辑)。
    - 个人中心集成日报摘要。
    - 优化日历视图 UI。
    - 修复项目详情页商机关联功能。

## 2026-01-05 紧急修复与回归处理
- **联系人管理修复**
  - [x] 恢复缺失的“删除”按钮（Vue 组件 `ContactsList.vue`）
  - [x] 修正后端删除逻辑中的字段错误（将 `position` 修正为 `title`）
- **业绩目标系统增强**
  - [x] 修复批量更新 500 错误（处理 `DepartmentModel` 关联逻辑）
  - [x] **新增自动汇总逻辑**：个人目标更新后自动聚合至部门，月度目标自动聚合至季度和年度
  - [x] 修复前端部门显示为 ID 数字的问题，实现动态名称映射
  - [x] 补齐 `PerformanceTarget` 缺失的毛利与营收字段
- **系统稳定性与体验优化**
  - [x] 修复 `signals.py` 中的回归错误（处理 `Opportunity` 信号中的 `creator` 与 `sales_manager` 安全访问）
  - [x] 修复 AI 润色日报后编辑内容不一致的问题
  - [x] 移除了已废弃的 Customer 状态检查逻辑，防止 server crash
- **AI 配置管理**
  - [x] 验证并确认“设为默认”功能逻辑正确，支持一键切换系统主模型配置
- **系统审计与管理功能**
  - [x] 实现“系统日志”侧边栏功能，支持按时间、部门、用户、行为类型多维筛选
  - [x] 实现日志全量 CSV 导出功能
  - [x] 规划并预留“数据管理”栏目，用于未来数据的备份与恢复功能

## 2026-01-06 核心功能深度重构与 AI 交互优化
- **AI 赋能深度优化**
  - [x] **交互升级**：将“AI 润色”改为“原地编辑”模式。用户点击后内容直接在编辑器内更新，保留撤销历史，不再强制保存退出，极大提升了写日报的流畅度。
  - [x] **接口修复**：修正了 AI 接口 404 路径错误，确保润色功能稳定可用。
- **业绩目标管理体系重构**
  - [x] **三位一体指标**：统一为“回款毛利”、“确认收入”、“新签合同”三大核心指标。
  - [x] **自动化聚合**：实现了月度目标自动累加至季度和年度的后端逻辑，确保数据全局一致。
  - [x] **部门拆分逻辑**：实现部门经理“余额自动补齐”规则。部门目标拆分给成员后，经理个人目标自动计算为剩余部分，且总和受部门总额约束。
  - [x] **树形视图修复**：解决了新增业绩目标后列表不刷新、数据挂载位置错误的 Bug。
- **UI/UX 现代化改造**
  - [x] **数据管理页面重构**：采用卡片流式布局，优化了视觉对齐和图标使用，风格更加现代化。
  - [x] **编译稳定性**：清理了 `DataManagement.vue` 的冗余代码，解决了 Vite 编译冲突。
- **环境稳定性维护**
  - [x] 解决了本地开发环境 8000 端口占用问题，固化了 `manage.py runserver` 启动脚本。

## 下一步规划
- [ ] **数据保障**：正式实现“数据管理”中的全量 JSON 导出与一键恢复功能。
- [ ] **报表增强**：在业绩报表中增加“目标完成率”环比与同比分析图表。
- [ ] **AI 扩展**：研究 AI 对商机进展的自动化评估，提供“成交可能性”分值。
- [ ] **移动端适配**：开始评估并优化移动端访问核心业务模块的体验。
