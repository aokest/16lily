# 🤝 项目交接与开发指南 (Project Handover)

> 版本: 2025-12-12  
> 状态: 正常（列表/默认模型已恢复）；AI解析存在问题待修复

本文档用于快速交接，让后续 AI/开发者清楚项目目标、进度、方法、问题与计划。

## 1. 项目目标与范围

- 统一“商机/客户/活动/赛事/审批/社媒”的业务闭环，提供数据看板与 AI 辅助录入
- 支持 Docker 一键开发环境；前后端解耦（Django REST + Vue3）
- 核心体验：AI自然语言 → 结构化表单 → 审批联动 → 列表/看板/报表

## 2. 当前状态

### 1.1 项目身份
- **项目名称**: 石榴粒粒 (16Lily) - 综合业务管理系统
- **核心定位**: 数字化作战指挥中心，打破部门壁垒。

### 2.1 环境与架构
- **Docker**: ✅ 服务 (Web, DB, Dashboard) 运行正常。
- **Backend**: Django REST Framework (Port 8000)。
- **Frontend**: Vue 3 + Element Plus (Port 8080)。
- **Database**: PostgreSQL。
 - **Tests**: 统一目录 `tests/`，每次开发完成需产出报告到 `tests/reports/`。

### 2.2 近期关键进展
1.  **商机表单升级**:
    - **字段丰富化**: 新增产线、行业、区域、联系人(姓名/电话/邮箱)、项目经理等字段。
    - **UI 优化**: 将 AI 智能录入框移至顶部，优化布局。
    - **性能优化**: 修复保存报错，并优化保存速度（非空字段跳过 AI 重解析）。
2.  **客户管理模块 (Customer CRM)**:
    - **从无到有**: 实现了完整的客户管理模块 (Model + API + Frontend)。
    - **双向关联**: 商机与客户通过 `customer_code` 和 `name` 自动关联。
    - **权限修正**: 修复了 API 权限问题 (`owner` 字段设为只读)。
3.  **统一活动中心 & 审批框架**:
    - 引入 `ActivityLog` 用于记录模型事件（商机/客户/联系人/活动/赛事/审批）。
    - 引入 `ApprovalRequest` 统一审批请求，自动指派到对应部门经理；管理员可越权批准。
    - 商机移交：同时指派接收人与销售部门经理审批。
4.  **社媒粉丝审批接入**:
    - `SocialMediaStats` 增加 `status/creator` 字段，创建即生成审批并写入活动流。
    - API：`/api/social-stats/` 支持创建与列表。
5.  **导航与报表**:
    - 新增 `CRM 首页` `/crm` 与双向入口；大屏右上角加入“CRM首页/业绩报表”。
    - 新增 `/reports/performance`，展示目标/实际对比与阶段分布。
6.  **测试体系落地**:
    - 新建 `tests/` 目录与模板；产出审批测试报告 `tests/reports/2025-12-10-approvals.md`。
    - 脚本：`python manage.py verify_approvals`、`python manage.py verify_socialmedia`。

## 3. 工作方法

- 前后端改动遵循“先读→仿写→最小改动→可观测性/日志”
- 所有数据改动走 API 与 ViewSet，统一在 `ActivityLog` 记录
- 提交前尽量确保页面“可执行”，失败时提供兜底填表避免阻塞
- 重要变更同时更新 `/docs` 文档，保证下一位接手者可快速继续

## 4. 下一步计划（高优先级）

**核心目标**: 完善 CRM 闭环，修复遗留的小问题，并统一导航入口。

1.  **活动流统一 (Activity Feed)**:
    - **现状**: Admin 的“最近动作”仅记录 Admin 页面操作，不覆盖 API/前端。
    - **策略**: 暂不继续折腾 Admin。统一在 `dashboard/activities` 输出业务动态（商机日志 + 客户事件）。
    - **后续**: 已上线 `ActivityLog`，继续扩展到市场活动与社媒粉丝审批事件。
2.  **商机-客户深度关联**:
    - **优化**: 在新建商机时，支持从下拉菜单选择已存在的客户（目前是文本匹配）。
3.  **业绩统计 (Achievement Stats)**:
    - **现状**: 已上线 `/reports/performance` 页面，入口位于 CRM 导航及大屏右上角。
    - **后续**: 增加时间维度筛选与个人/部门分层视图。

## 5. 给接手 AI 的提示词

如果你是接手的 AI，请读取以下指令开始工作：

```text
你好，我是接手的 AI。我已经阅读了 HANDOVER.md。
目前的任务重点是：
1. 活动流显示“审批驳回”原因与责任人标签，并对审批类事件加颜色标识。
2. 社媒粉丝前端视图：新增录入与列表页，打通市场审批流程。
3. 业绩报表深化：增加时间区间筛选、个人/部门维度切换与趋势图。
4. 对话接口 Phase A：实现 `POST /api/chat/` 适配层，打通商机/客户/活动/赛事 CRUD 与审批，按 `AI_DIALOGUE_ARCHITECTURE.md` 执行。

入口导航：CRM首页 `/crm`，商机 `/crm/opportunities`，客户 `/crm/customers`，报表 `/reports/performance`，大屏 `/`。

审批API用法：
1) 列表我的待审批：`GET /api/approvals/`（管理员可查看全部）
2) 审批通过：`POST /api/approvals/{id}/approve` JSON: `{"reason": "同意"}`
3) 审批驳回：`POST /api/approvals/{id}/reject` JSON: `{"reason": "信息不完整"}`
审批动作会写入 `ActivityLog` 并在大屏活动流展示。
```

## 6. 常用命令

```bash
# 启动所有服务
docker-compose up -d --build

# 重启 Web 服务 (代码变更后)
docker-compose restart web

# 查看日志
docker-compose logs -f web

# 运行审批验证脚本
docker-compose exec web python manage.py verify_approvals
```
3.  **统一活动中心 & 审批框架**:
    - 引入 `ActivityLog` 用于记录模型事件（商机/客户/联系人/活动/赛事）。
    - 引入 `ApprovalRequest` 统一审批请求，自动指派到对应部门经理；管理员可越权批准。
    - 商机移交：同时指派接收人与销售部门经理审批。
## 7. 现存问题（需重点关注）

1) DeepSeek 解析失败（AI分析按钮返回 error）  
   - 表现：返回含解释/代码块的非纯JSON，清洗后仍解析失败；二次调用（降温+严格指令）效果不稳定  
   - 影响：AI分析正常路径不工作，当前以兜底填表保证流程不阻塞  
   - 诊断缺口：缺少原始返回与 provider/base_url/model 的日志记录，定位不够精准  
   - 计划：加入原始返回记录到 `SubmissionLog`；改造为函数调用/工具调用强约束JSON；提供“AI自测”入口  

2) 智能体模型选择宽度与交互  
   - 表现：下拉过窄或过宽影响布局  
   - 计划：设定 320px 宽度并响应式不挤压按钮；显示“默认”标识与 provider

3) 兜底需全面覆盖  
   - 现状：商机/赛事已覆盖；客户/活动后端已扩展兜底，但前端表单未自动填充  
   - 计划：在“智能执行面板”实现客户/活动的自动填充与字段提示标签

4) 可观测性不足  
   - 现状：失败时仅弹框提示  
   - 计划：在 Admin “系统工具”加“后端/数据库/AI健康检查”与“解析自测”
1. 工种序列/岗位/职级在 Django Admin 中的下拉联动仍显生硬：
   - 现状：后端已严格校验（M/S 岗位=职级，P 序列岗位必选），但前端下拉仍会出现混合选项。
   - 方案：在 Admin SPA 迁移后实现前端动态过滤与联动，彻底解决交互生硬问题；本需求已加入 `PROJECT_TRACKING.md` 的需求池。

2. 导航分类不科学、重复入口过多（社媒相关分散为多个菜单）：
   - 决策：Admin SPA 中统一“社媒管理”为模块首页，子页包含“账号/粉丝/管理员/历史”；其他模块按“经营中心/销售管理/客户关系/AI中枢/系统配置”分层。
   - 临时策略：Django Admin 保持可访问，减少改动以避免二次成本；核心导航以前端 CRM 为主。

3. Admin 顶部菜单前端入口不可用：
   - 原因：链接未指向前端端口 8080
   - 处理：已改为 `http://127.0.0.1:8080/#/...` 并同步侧栏快捷入口，现可用

## 8. 今日工作总结（2025-12-12）
- 修复 CRM 列表失败与路由导入问题
- 上线客户标签、外部ID映射、客户分群（含前端保存/应用）
- 业绩报表中英结合、客户筛选扩展（行业/状态/区域）
- Admin 迁移：顶部菜单加入前端入口、侧栏精简、快捷看板与组织架构图
- AI 对话窗：审批助手/客户助手/商机助手三页签友好交互

## 9. 待办清单

- DeepSeek 解析日志与函数调用改造（严格JSON输出，加入重试与采样降温）
- 模型选择宽度统一为 320px 并响应式布局
- 客户/活动的前端兜底自动填表与字段标签说明
- Admin 系统工具：AI解析自测与健康检查
- 统一前端侧边栏分组与模块首页子页导航
- 商机项目组与日志交互增强（删除/编辑、工时与角色）
- 审批助手预设视图（我的待办、我已处理）
- 活动/赛事助手接入对话接口
