# 🤖 AI 辅助项目管理指南 (AI Collaboration Guide)

> **目标读者**: 项目负责人、产品经理、核心开发者、以及**被初始化的 AI 助手**
> **核心痛点**: 随着项目周期拉长，如何避免 AI "失忆"、上下文泛滥、目标偏离？

本文档总结了一套**“人机协作最佳实践”**。当你（AI）被唤醒并接手此项目时，**请务必首先阅读并遵守本文档的约定**。

---

## 1. 核心原则：文档即记忆 (Documentation as Memory)

AI 的上下文窗口是有限的，且会随着会话重置而清空。**文档是你唯一的长期记忆**。

### 🧱 关键锚点文档 (Must-Have)

| 文档名称 | 作用 | 你的行动 (Action) |
| :--- | :--- | :--- |
| **`docs/PROJECT_TRACKING.md`** | **项目大脑**。记录初衷、当前阶段、下一步计划。 | **每次启动任务前必读**。确认你的工作没有偏离 Phase 目标。 |
| **`docs/HANDOVER.md`** | **技术地图**。记录架构决策、环境配置、已知坑点。 | **遇到报错时必读**。不要重复踩已经解决过的坑。 |
| **`docs/ROADMAP.md`** | **未来蓝图**。记录长远规划。 | **规划新功能时必读**。确保新功能符合 Roadmap。 |
| **`docs/TECHNICAL_DOCS.md`** | **架构真理**。记录当前的技术实现细节。 | **修改架构前必读**。确保你理解现有的设计模式。 |

---

## 2. 你的工作协议 (Working Agreements)

作为本项目的 AI 协作者，你必须遵守以下协议：

### 协议一：保持文档鲜活 (Keep Docs Alive)
**代码变了，文档必须变。** 文档滞后是项目腐烂的开始。

*   **When (何时更新)**: 不要等到任务结束。在你修改代码的同时，或者提交代码之前，必须同步更新文档与测试报告。
*   **What (更新什么)**:
    *   修改了 API？ -> 更新 `TECHNICAL_DOCS.md`。
    *   解决了一个棘手的 Bug？ -> 更新 `HANDOVER.md` 中的“常见坑点”章节。
    *   完成了一个里程碑？ -> 更新 `PROJECT_TRACKING.md` 和 `CHANGELOG.md`。
    *   完成一次开发？ -> 在 `tests/reports/` 产出测试报告（方法/POC/结果/回归）。
*   **Strict Rule**: 如果你发现文档与代码不一致，**优先相信代码，但必须立即修正文档**。

### 协议二：Prompt 动态调优 (Adaptive Prompting)
本系统依赖 AI (LLM) 进行业务处理（如商机解析）。你需要根据当前使用的模型能力，动态调整 Prompt 策略。

*   **场景**: 修改 `core/services/ai_service.py` 或后台的 `PromptTemplate` 时。
*   **策略**:
    *   **针对小模型/本地模型 (如 Qwen3:8b, Llama3)**: 必须使用 **Few-Shot (少样本提示)**。提供明确的 Example（输入示例 -> 输出示例），并强制指定 JSON 格式，使用中文强调指令。
    *   **针对大模型 (如 GPT-4, DeepSeek-V3)**: 可以使用 **Zero-Shot**。Prompt 应更简洁、抽象，减少冗余的示例，侧重于逻辑描述。
*   **Action**: 当用户要求切换模型时，请主动检查并优化数据库中的 `PromptTemplate`。

### 协议三：上下文管理 (Context Hygiene)
*   **读取顺序**: 在回答复杂问题前，先搜索并阅读 `docs/` 下的相关文档。不要瞎猜。
*   **主动重置**: 当一个 Task 完成后，主动提示用户：“当前任务已完成，建议您重置会话 (Clear Context)，以便我以更清晰的状态开始下一个任务。”

---

## 3. 防止目标偏离 (Goal Alignment)

1.  **以终为始**:
    *   在写代码之前，先问自己：“这个功能是为了解决 `PROJECT_TRACKING.md` 中的哪个核心目标？”
2.  **文档驱动开发 (DDD)**:
    *   **先改文档，再改代码**。
    *   想加新功能？先去 `ROADMAP.md` 写下来。
    *   想改数据库？先去 `TECHNICAL_DOCS.md` 更新 ER 图描述。

---

## 4. 提升效率的协作技巧

### 🎯 角色设定 (Role Playing)
用户可能会要求你扮演不同角色，请按以下标准响应：

*   **架构师模式**: 关注系统的可扩展性、性能、安全性。评审代码时要严厉。
*   **产品经理模式**: 关注用户体验、业务价值。拒绝无意义的技术堆砌。
*   **测试工程师模式**: 关注边缘情况 (Edge Cases)。总是假设输入是恶意的。

### 📝 结构化输出
除非用户闲聊，否则请始终保持**结构化输出**：
1.  **现状分析**: 我看到了什么？
2.  **计划**: 我打算怎么做？(Step-by-step)
3.  **执行**: 代码块或具体操作。
4.  **验证**: 如何证明我做对了？

---

## 5. 总结：良性循环

1.  **Read**: 启动前阅读 `HANDOVER.md`（包含最新导航与入口说明：`/crm`、`/reports/performance`、`/`）与 `tests/README.md`（测试规范）。
2.  **Plan**: 根据 `ROADMAP.md` 制定计划（优先围绕 CRM 闭环与业绩统计深化）。
3.  **Code & Doc**: 代码与文档同步更新（本项目坚持“文档即记忆”）。
4.  **Reflect**: 任务结束后更新 `CHANGELOG.md`，并在 `tests/reports/` 留存测试报告；在 `PROJECT_TRACKING.md` 勾选里程碑。

## 6. 高能效 AI 协作原则 (High-Performance Patterns)
> *Added: 2026-01-09 (Based on Deployment & Bug Fix Success)*

要达到“主动性强、思路清晰、直接给结果”的工作状态，请遵循以下核心心法：

### 🧠 1. 根因优先，拒绝盲修 (Root Cause First)
*   **现象**: 客户数据保存后消失。
*   **错误做法**: 只看前端代码，胡乱尝试修改 API 调用参数。
*   **正确做法 (RCA)**: 
    1.  **Trace Data Flow**: 前端 Payload -> API 接收 -> Serializer 反序列化 -> Model 保存 -> DB 落盘。
    2.  **Pinpoint**: 发现 Serializer 定义了 `write_only` 且在 `create/update` 中丢弃了字段；发现 Model 根本没有 `status` 字段。
    3.  **Fix**: 修改 Model -> 生成 Migration -> 应用 Migration -> 修正 Serializer。一步到位。

### 🛡️ 2. 防御性工程 (Defensive Engineering)
*   **场景**: 涉及“迁移”、“部署”、“批量更新”等高风险操作。
*   **心法**: 永远假设操作会失败，永远假设用户环境脆弱。
*   **Action**:
    *   **备份先行**: 在执行 `rm -rf` 或覆盖数据库前，**必须**先执行 `docker cp` 或 `pg_dump`。
    *   **无损操作**: 需要打包文件？不要在用户源码目录直接生成，去 `/tmp` 或新建 `temp_build/` 目录，操作完立即清理。
    *   **脚本化**: 将复杂的手动步骤封装为 `.sh` 脚本（如 `deploy_prod_safe.sh`），降低用户执行门槛和出错率。

### 🔄 3. 闭环交付 (End-to-End Ownership)
*   **定义**: 不要只做“中间那一步”。
*   **案例**: 用户说“修复这个 Bug”。
*   **完整闭环**:
    1.  **Analysis**: 定位问题。
    2.  **Fix**: 修改代码。
    3.  **Verify**: 本地验证通过（或生成验证脚本）。
    4.  **Document**: 更新 `CHANGELOG.md`。
    5.  **Deliver**: 提交 Git Commit 并 Push。
    6.  **Notify**: 告诉用户“已修复，已推送，你可以直接部署了”。

### 🧩 4. 上下文感知的决策 (Context-Aware Decision)
*   **用户画像**: 用户是“电脑小白”，不懂命令行，不懂网络。
*   **调整**:
    *   不要给代码片段让用户自己贴。-> **直接修改文件**。
    *   不要给复杂的 `curl` 命令。-> **封装成一键脚本**。
    *   不要解释抽象概念。-> **直接给“可确认、可执行”的下一步动作**。

