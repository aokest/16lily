# 🛠️ 修复与演进计划 (Fix & Evolution Plan)

针对您提出的 "AI 功能不可用" 问题以及后续开发方向，我制定了以下详细计划。

## 🔴 紧急修复：AI 填单功能 (Priority Fixes)

目前 AI 填单报错的核心原因在于：**后端返回了无法序列化的数据库对象（导致接口报错），且前端无法处理下拉菜单（Select2）的自动赋值。**

### 1. 修复 AI 服务层 (`core/services/ai_service.py`)
*   **问题**: `find_user` 等方法直接返回了 Django 模型对象 (User Object)，导致 API 返回 JSON 时序列化失败 (500 Error)。
*   **修复**:
    *   修改 `parse_opportunity` 等方法，将返回的对象转换为 **ID** (例如 `sales_manager_id`)。
    *   增加 `find_customer` 方法，支持通过客户名称模糊匹配并返回 **Customer ID**。
    *   对于无法匹配的关联字段（如客户不存在），返回 `None` 并提示用户。

### 2. 增强前端交互 (`templates/admin/core/ai_change_form.html`)
*   **问题**: 简单的 `element.value = xxx` 无法触发生效，特别是针对 Django Admin 的 **Select2 (下拉搜索框)** 和 **日期组件**。
*   **修复**:
    *   引入 `jQuery` 触发机制：`$(element).val(id).trigger('change')`，确保下拉菜单能正确显示选中项。
    *   优化日期字段处理，兼容 Django 的拆分式日期输入框。
    *   优化错误提示：将 "报错" 改为温和的 "待补充字段" 提示，避免给用户挫败感。

### 3. 优化 Prompt (提示词)
*   **问题**: AI 过于诚实，不知道的信息就不填，导致大量留白。
*   **优化**: 指导 AI 进行合理的 **"默认值推断"** (例如：商机阶段默认为"初步接触"，日期默认为"今天")，减少用户补录工作量。

---

## 📅 后续开发计划 (Roadmap)

解决完上述 Bug 后，建议按以下优先级推进：

### 第一阶段：数据可视化与大屏实装 (P1)
*   **目标**: 让 `frontend_dashboard` 不再是静态页面，而是显示实时数据库数据。
*   **动作**:
    *   完善 `DashboardViewSet` 接口，输出符合 ECharts 格式的 JSON 数据。
    *   改造前端大屏 (Vue.js)，对接后端 API，实现业绩、商机漏斗的实时刷新。

### 第二阶段：OCR 与多模态录入 (P2)
*   **目标**: 支持上传名片/文档图片，自动录入信息。
*   **动作**:
    *   集成支持 Vision 的大模型 (如 GPT-4o 或 Qwen-VL)。
    *   在 AI 侧边栏增加 "上传图片" 按钮。

### 第三阶段：移动端适配与审批流 (P3)
*   **目标**: 方便手机操作。
*   **动作**:
    *   引入简单的 H5 移动端界面 (非 Admin 界面)，供销售人员快速打卡、录入日报。
    *   实现基于状态机的标准审批流 (提交 -> 经理审批 -> 财务审批)。

---

**是否确认先执行【紧急修复】部分，解决 AI 填单不可用的问题？**